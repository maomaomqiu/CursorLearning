# Everything Claude Code - ä¸Šä¸‹æ–‡å’Œå†…å­˜ç®¡ç†å®Œæ•´åˆ†æ

> åŸºäº `github.com/affaan-m/everything-claude-code` çš„æ·±åº¦ä»£ç åˆ†æ

---

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ ¸å¿ƒå®ç°æœºåˆ¶](#æ ¸å¿ƒå®ç°æœºåˆ¶)
  - [1. ä¼šè¯å­˜å‚¨ç³»ç»Ÿ](#1-ä¼šè¯å­˜å‚¨ç³»ç»Ÿ)
  - [2. ç”Ÿå‘½å‘¨æœŸé’©å­](#2-ç”Ÿå‘½å‘¨æœŸé’©å­)
  - [3. æŒç»­å­¦ä¹ ç³»ç»Ÿ](#3-æŒç»­å­¦ä¹ ç³»ç»Ÿ)
- [ä»£ç åˆ†æè¿‡ç¨‹](#ä»£ç åˆ†æè¿‡ç¨‹)
- [æœ€å°å®‰è£…æ–¹æ¡ˆ](#æœ€å°å®‰è£…æ–¹æ¡ˆ)
- [å®é™…ä½¿ç”¨æµç¨‹](#å®é™…ä½¿ç”¨æµç¨‹)
- [æ ¸å¿ƒä»£ç è§£æ](#æ ¸å¿ƒä»£ç è§£æ)

---

## æ¦‚è¿°

Everything Claude Code é€šè¿‡ **ä¸‰ä¸ªå…³é”®ç»„ä»¶** å®ç°è·¨ä¼šè¯çš„ä¸Šä¸‹æ–‡å’Œå†…å­˜ç®¡ç†ï¼š

1. **ä¼šè¯å­˜å‚¨ç³»ç»Ÿ** - æŒä¹…åŒ–ä¼šè¯çŠ¶æ€åˆ° `.tmp` æ–‡ä»¶
2. **ç”Ÿå‘½å‘¨æœŸé’©å­** - è‡ªåŠ¨åŒ–ä¼šè¯å¼€å§‹/ç»“æŸæ—¶çš„ä¸Šä¸‹æ–‡ç®¡ç†
3. **æŒç»­å­¦ä¹ ç³»ç»Ÿ** - å°†é‡å¤æ¨¡å¼æå–ä¸ºå¯å¤ç”¨çš„ skills

è¿™äº›æœºåˆ¶çš„ç›®æ ‡æ˜¯ï¼š**ä»æ¯æ¬¡ä»é›¶å¼€å§‹ â†’ ç§¯ç´¯å¼å·¥ä½œï¼Œé¿å…ä¸Šä¸‹æ–‡è…çƒ‚ï¼ˆcontext rotï¼‰**

---

## æ ¸å¿ƒå®ç°æœºåˆ¶

### 1. ä¼šè¯å­˜å‚¨ç³»ç»Ÿ

**å­˜å‚¨ä½ç½®**ï¼š`~/.claude/sessions/`

**æ–‡ä»¶å‘½å**ï¼š`YYYY-MM-DD-<session-id>-session.tmp`

**æ–‡ä»¶ç»“æ„ç¤ºä¾‹**ï¼š

```markdown
# Session: Auth Feature Implementation
**Date:** 2026-01-20
**Started:** 14:30
**Last Updated:** 17:45

---

## Current State

Working on JWT authentication flow for the API.

### Completed
- [x] Set up JWT signing with RS256
- [x] Created `/auth/login` endpoint
- [x] Fixed token expiry bug (was using seconds, needed milliseconds)

### In Progress
- [ ] Add rate limiting to auth endpoints
- [ ] Implement token blacklist for logout

### Blockers Encountered
1. **jsonwebtoken version mismatch** - v9.x changed the `verify()` signature
   - Solution: Updated error handling from `err.name === 'TokenExpiredError'` to `err instanceof jwt.TokenExpiredError`

2. **Redis TTL for refresh tokens** - Was setting TTL in seconds but passing milliseconds
   - Solution: Use string format `expiresIn: '15m'` instead of `Date.now() + 900000`

### Key Decisions Made
- Using RS256 over HS256 for better security with distributed services
- Storing refresh tokens in Redis with 7-day TTL
- Access tokens expire in 15 minutes

### Code Locations Modified
- `src/middleware/auth.js` - JWT verification middleware
- `src/routes/auth.js` - Login/logout/refresh endpoints
- `src/services/token.service.js` - Token generation and validation

### Notes for Next Session
- Need to add CSRF protection for cookie-based token storage
- Consider adding fingerprinting for refresh token binding

### Context to Load
```
src/middleware/
src/routes/auth.js
src/services/token.service.js
```
```

**å…³é”®ä»·å€¼**ï¼š
- âœ… è®°å½•**æˆåŠŸçš„æ–¹æ³•**ï¼ˆé¿å…é‡æ–°å‘ç°ï¼‰
- ğŸš« è®°å½•**å¤±è´¥çš„å°è¯•**ï¼ˆé¿å…é‡å¤çŠ¯é”™ï¼‰
- ğŸ“ è®°å½•**å…³é”®å†³ç­–**ï¼ˆä¿æŒä¸Šä¸‹æ–‡ä¸€è‡´æ€§ï¼‰
- ğŸ“‚ æŒ‡å®š**ä¸‹æ¬¡åŠ è½½çš„æ–‡ä»¶**ï¼ˆå¿«é€Ÿæ¢å¤å·¥ä½œçŠ¶æ€ï¼‰

---

### 2. ç”Ÿå‘½å‘¨æœŸé’©å­

è¿™æ˜¯å†…å­˜ç®¡ç†çš„æ ¸å¿ƒè‡ªåŠ¨åŒ–æœºåˆ¶ï¼Œé€šè¿‡ 4 ä¸ªé’©å­å®ç°æ— ç¼çš„è·¨ä¼šè¯è®°å¿†ï¼š

#### **SessionStart Hook** (`session-start.js`)

**è§¦å‘æ—¶æœº**ï¼šæ–°ä¼šè¯å¼€å§‹æ—¶

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```javascript
// 1. æŸ¥æ‰¾æœ€è¿‘ 7 å¤©çš„ä¼šè¯æ–‡ä»¶
const recentSessions = findFiles(sessionsDir, '*-session.tmp', { maxAge: 7 });

// 2. è¯»å–æœ€æ–°ä¼šè¯å†…å®¹
const content = readFile(latest.path);

// 3. è‡ªåŠ¨æ³¨å…¥åˆ° Claude çš„ä¸Šä¸‹æ–‡ä¸­
if (content && !content.includes('[Session context goes here]')) {
  output(`Previous session summary:\n${content}`);
}
```

**ä¾èµ–å…³ç³»**ï¼š
```javascript
const {
  getSessionsDir,
  getLearnedSkillsDir,
  findFiles,
  ensureDir,
  readFile,
  log,
  output
} = require('../lib/utils');

const { getPackageManager, getSelectionPrompt } = require('../lib/package-manager');
const { listAliases } = require('../lib/session-aliases');
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
[SessionStart] Found 3 recent session(s)
[SessionStart] Latest: ~/.claude/sessions/2026-02-15-abc123-session.tmp
[SessionStart] 5 learned skill(s) available
[SessionStart] Package manager: pnpm (detected from lock file)
```

---

#### **SessionEnd Hook** (`session-end.js`)

**è§¦å‘æ—¶æœº**ï¼šä¼šè¯ç»“æŸæ—¶

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```javascript
// 1. è§£æä¼šè¯è½¬å½•ï¼ˆtranscript JSONLï¼‰
const summary = extractSessionSummary(transcriptPath);

// 2. æå–å…³é”®ä¿¡æ¯
{
  userMessages: [...],      // æœ€å 10 æ¡ç”¨æˆ·æ¶ˆæ¯
  toolsUsed: [...],         // ä½¿ç”¨çš„å·¥å…·ï¼ˆæœ€å¤š 20 ä¸ªï¼‰
  filesModified: [...],     // ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆæœ€å¤š 30 ä¸ªï¼‰
  totalMessages: 42
}

// 3. ç”Ÿæˆå¹¶ä¿å­˜æ‘˜è¦
const sessionFile = path.join(
  sessionsDir,
  `${today}-${shortId}-session.tmp`
);
writeFile(sessionFile, template);
```

**è½¬å½•è§£æé€»è¾‘**ï¼š
```javascript
function extractSessionSummary(transcriptPath) {
  const lines = content.split('\n').filter(Boolean);
  const userMessages = [];
  const toolsUsed = new Set();
  const filesModified = new Set();

  for (const line of lines) {
    const entry = JSON.parse(line);

    // æ”¶é›†ç”¨æˆ·æ¶ˆæ¯
    if (entry.type === 'user' || entry.role === 'user') {
      const text = extractText(entry.message?.content ?? entry.content);
      userMessages.push(text.trim().slice(0, 200));
    }

    // æ”¶é›†å·¥å…·ä½¿ç”¨å’Œæ–‡ä»¶ä¿®æ”¹
    if (entry.type === 'tool_use' || entry.tool_name) {
      toolsUsed.add(entry.tool_name || entry.name);

      if (toolName === 'Edit' || toolName === 'Write') {
        filesModified.add(entry.tool_input?.file_path);
      }
    }
  }

  return { userMessages, toolsUsed, filesModified, totalMessages };
}
```

**ä¾èµ–å…³ç³»**ï¼š
```javascript
const {
  getSessionsDir,
  getDateString,
  getTimeString,
  getSessionIdShort,
  ensureDir,
  readFile,
  writeFile,
  replaceInFile,
  log
} = require('../lib/utils');
```

---

#### **PreCompact Hook** (`pre-compact.js`)

**è§¦å‘æ—¶æœº**ï¼šä¸Šä¸‹æ–‡å‹ç¼©å‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```javascript
// 1. è®°å½•å‹ç¼©äº‹ä»¶
const compactionLog = path.join(sessionsDir, 'compaction-log.txt');
appendFile(compactionLog, `[${timestamp}] Context compaction triggered\n`);

// 2. åœ¨æ´»åŠ¨ä¼šè¯æ–‡ä»¶ä¸­æ ‡è®°
const activeSession = sessions[0].path;
appendFile(activeSession,
  `\n---\n**[Compaction occurred at ${timeStr}]** - Context was summarized\n`
);
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªé’©å­ï¼Ÿ**
- ä¸Šä¸‹æ–‡å‹ç¼©ä¼šä¸¢å¤±éƒ¨åˆ†ä¿¡æ¯
- æ ‡è®°å‹ç¼©æ—¶é—´ç‚¹ï¼Œä¾¿äºè¿½æº¯
- åœ¨ä¼šè¯æ–‡ä»¶ä¸­ä¿ç•™"å‹ç¼©å‘ç”Ÿ"çš„è®°å½•

**ä¾èµ–å…³ç³»**ï¼š
```javascript
const {
  getSessionsDir,
  getDateTimeString,
  getTimeString,
  findFiles,
  ensureDir,
  appendFile,
  log
} = require('../lib/utils');
```

---

#### **Stop Hook - Continuous Learning** (`evaluate-session.js`)

**è§¦å‘æ—¶æœº**ï¼šä¼šè¯ç»“æŸæ—¶ï¼ˆStop äº‹ä»¶ï¼‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```javascript
// 1. æ£€æŸ¥ä¼šè¯é•¿åº¦
const messageCount = countInFile(transcriptPath, /"type"\s*:\s*"user"/g);

// 2. è¿‡æ»¤çŸ­ä¼šè¯
if (messageCount < minSessionLength) {
  log(`Session too short (${messageCount} messages), skipping`);
  process.exit(0);
}

// 3. æ ‡è®°éœ€è¦è¯„ä¼°
log(`Session has ${messageCount} messages - evaluate for extractable patterns`);
log(`Save learned skills to: ${learnedSkillsPath}`);
```

**é…ç½®æ–‡ä»¶** (`skills/continuous-learning/config.json`)ï¼š
```json
{
  "min_session_length": 10,
  "extraction_threshold": "medium",
  "learned_skills_path": "~/.claude/skills/learned/",
  "patterns_to_detect": [
    "error_resolution",        // é”™è¯¯è§£å†³æ–¹æ¡ˆ
    "user_corrections",        // ç”¨æˆ·çº æ­£çš„æ¨¡å¼
    "workarounds",            // æ¡†æ¶/åº“çš„å˜é€šæ–¹æ¡ˆ
    "debugging_techniques",    // æœ‰æ•ˆçš„è°ƒè¯•æ–¹æ³•
    "project_specific"        // é¡¹ç›®ç‰¹å®šçš„çº¦å®š
  ],
  "ignore_patterns": [
    "simple_typos",
    "one_time_fixes",
    "external_api_issues"
  ]
}
```

**ä¸ºä»€ä¹ˆç”¨ Stop Hook è€Œä¸æ˜¯ UserPromptSubmitï¼Ÿ**

| é’©å­ç±»å‹ | è§¦å‘é¢‘ç‡ | æ€§èƒ½å½±å“ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|---------|
| UserPromptSubmit | æ¯æ¡æ¶ˆæ¯ | å¢åŠ å»¶è¿Ÿ | å®æ—¶éªŒè¯ |
| Stop | ä¼šè¯ç»“æŸ | æ— å»¶è¿Ÿ | æ‰¹é‡åˆ†æ |

**ä¾èµ–å…³ç³»**ï¼š
```javascript
const {
  getLearnedSkillsDir,
  ensureDir,
  readFile,
  countInFile,
  log
} = require('../lib/utils');
```

---

### 3. æŒç»­å­¦ä¹ ç³»ç»Ÿ

**ç›®æ ‡**ï¼šå°†é‡å¤å‡ºç°çš„è§£å†³æ–¹æ¡ˆè‡ªåŠ¨è½¬åŒ–ä¸ºå¯å¤ç”¨çš„ skills

**å·¥ä½œæµç¨‹**ï¼š

```mermaid
graph LR
    A[ä¼šè¯ç»“æŸ] --> B{æ¶ˆæ¯æ•° >= 10?}
    B -->|å¦| C[è·³è¿‡]
    B -->|æ˜¯| D[åˆ†ææ¨¡å¼]
    D --> E[æå–çŸ¥è¯†]
    E --> F[ä¿å­˜ä¸º skill]
    F --> G[ä¸‹æ¬¡è‡ªåŠ¨åŠ è½½]
```

**æ¨¡å¼ç±»å‹**ï¼š

| æ¨¡å¼ç±»å‹ | æè¿° | ç¤ºä¾‹ |
|---------|------|------|
| error_resolution | é”™è¯¯è§£å†³æ–¹æ¡ˆ | "jsonwebtoken v9 breaking change" |
| user_corrections | ç”¨æˆ·çº æ­£çš„æ¨¡å¼ | "Always use expiresIn string format" |
| workarounds | æ¡†æ¶/åº“çš„å˜é€šæ–¹æ¡ˆ | "Redis TTL needs seconds not milliseconds" |
| debugging_techniques | æœ‰æ•ˆçš„è°ƒè¯•æ–¹æ³• | "Check package.json for version mismatches" |
| project_specific | é¡¹ç›®ç‰¹å®šçš„çº¦å®š | "JWT uses RS256 in this codebase" |

**ä¿å­˜ä½ç½®**ï¼š`~/.claude/skills/learned/`

**æ–‡ä»¶æ ¼å¼ç¤ºä¾‹**ï¼š
```markdown
---
name: jwt-v9-error-handling
description: Handle jsonwebtoken v9.x breaking changes
---

# JWT v9.x Error Handling

## Context
jsonwebtoken v9.x changed error handling from string-based to instanceof checks.

## Pattern
```javascript
// Old (v8)
if (err.name === 'TokenExpiredError') { ... }

// New (v9)
if (err instanceof jwt.TokenExpiredError) { ... }
```

## When to Use
- When upgrading from jsonwebtoken v8 to v9
- When handling JWT verification errors
```

---

## ä»£ç åˆ†æè¿‡ç¨‹

### æ­¥éª¤ 1ï¼šä»æ–‡æ¡£å…¥æ‰‹

è¯»å– `the-longform-guide.md`ï¼Œæ‰¾åˆ°å…³é”®æç¤ºï¼š
```markdown
For sharing memory across sessions, a skill or command that summarizes
and checks in on progress then saves to a `.tmp` file in your `.claude`
folder and appends to it until the end of your session is the best bet.

Example of session storage -> https://github.com/affaan-m/everything-claude-code/tree/main/examples/sessions

I've built these hooks and they're in the repo at
`github.com/affaan-m/everything-claude-code/tree/main/hooks/memory-persistence`
```

### æ­¥éª¤ 2ï¼šè¿½è¸ªé’©å­é…ç½®

è¯»å– `hooks/hooks.json`ï¼Œæ‰¾åˆ° 4 ä¸ªå…³é”®é’©å­ï¼š

```json
{
  "hooks": {
    "SessionStart": [...],    // ä¼šè¯å¼€å§‹
    "SessionEnd": [...],      // ä¼šè¯ç»“æŸ
    "PreCompact": [...],      // å‹ç¼©å‰
    "Stop": [...]             // æŒç»­å­¦ä¹ ï¼ˆå¯é€‰ï¼‰
  }
}
```

### æ­¥éª¤ 3ï¼šè¯»å–é’©å­è„šæœ¬

åˆ†ææ¯ä¸ªé’©å­è„šæœ¬çš„ `require()` è¯­å¥ï¼š

**session-start.js (ç¬¬ 10-22 è¡Œ)**ï¼š
```javascript
const {
  getSessionsDir,
  getLearnedSkillsDir,
  findFiles,
  ensureDir,
  readFile,
  log,
  output
} = require('../lib/utils');
const { getPackageManager, getSelectionPrompt } = require('../lib/package-manager');
const { listAliases } = require('../lib/session-aliases');
```

**session-end.js (ç¬¬ 13-24 è¡Œ)**ï¼š
```javascript
const {
  getSessionsDir,
  getDateString,
  getTimeString,
  getSessionIdShort,
  ensureDir,
  readFile,
  writeFile,
  replaceInFile,
  log
} = require('../lib/utils');
```

**pre-compact.js (ç¬¬ 12-20 è¡Œ)**ï¼š
```javascript
const {
  getSessionsDir,
  getDateTimeString,
  getTimeString,
  findFiles,
  ensureDir,
  appendFile,
  log
} = require('../lib/utils');
```

### æ­¥éª¤ 4ï¼šç»˜åˆ¶ä¾èµ–å›¾

```
session-start.js
â”œâ”€â”€ lib/utils.js              âœ“ å¿…éœ€
â”œâ”€â”€ lib/package-manager.js    âœ“ å¿…éœ€
â””â”€â”€ lib/session-aliases.js    âœ“ å¿…éœ€

session-end.js
â””â”€â”€ lib/utils.js              âœ“ å¿…éœ€

pre-compact.js
â””â”€â”€ lib/utils.js              âœ“ å¿…éœ€

evaluate-session.js (å¯é€‰)
â””â”€â”€ lib/utils.js              âœ“ å¿…éœ€
```

### æ­¥éª¤ 5ï¼šéªŒè¯ç›®å½•ç»“æ„

```bash
$ ls -la scripts/lib/
utils.js                 â† æ ¸å¿ƒå·¥å…·åº“
package-manager.js       â† session-start.js ä¾èµ–
session-aliases.js       â† session-start.js ä¾èµ–
session-manager.js       â† æœªè¢«ä½¿ç”¨ï¼ˆå¯å¿½ç•¥ï¼‰
```

### æ­¥éª¤ 6ï¼šåˆ†ææ ¸å¿ƒå·¥å…·åº“

è¯»å– `utils.js` (530 è¡Œ)ï¼Œå…³é”®å‡½æ•°ï¼š

```javascript
// ç›®å½•ç®¡ç†
getSessionsDir()          // â†’ ~/.claude/sessions
getLearnedSkillsDir()     // â†’ ~/.claude/skills/learned
ensureDir(path)           // è‡ªåŠ¨åˆ›å»ºç›®å½•

// æ—¥æœŸæ—¶é—´
getDateString()           // â†’ "2026-02-15"
getTimeString()           // â†’ "14:30"
getDateTimeString()       // â†’ "2026-02-15 14:30:00"

// æ–‡ä»¶æ“ä½œ
readFile(path)            // å®‰å…¨è¯»å–æ–‡ä»¶
writeFile(path, content)  // å†™å…¥æ–‡ä»¶
appendFile(path, content) // è¿½åŠ åˆ°æ–‡ä»¶
replaceInFile(path, search, replace)  // æ›¿æ¢æ–‡ä»¶å†…å®¹

// æ–‡ä»¶æŸ¥æ‰¾
findFiles(dir, pattern, { maxAge: 7 })  // æŸ¥æ‰¾æ–‡ä»¶ï¼Œæ”¯æŒå¹´é¾„è¿‡æ»¤

// ä¼šè¯ç®¡ç†
getSessionIdShort()       // ä»ç¯å¢ƒå˜é‡è·å–ä¼šè¯ ID

// é’©å­ I/O
log(message)              // è¾“å‡ºåˆ° stderrï¼ˆç”¨æˆ·å¯è§ï¼‰
output(data)              // è¾“å‡ºåˆ° stdoutï¼ˆä¼ é€’ç»™ Claudeï¼‰
```

---

## æœ€å°å®‰è£…æ–¹æ¡ˆ

### å¿…éœ€æ–‡ä»¶æ¸…å•ï¼ˆ6 ä¸ªæ–‡ä»¶ï¼‰

```
~/.claude/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ session-start.js      â† åŠ è½½ä¼šè¯ä¸Šä¸‹æ–‡
â”‚   â”‚   â”œâ”€â”€ session-end.js        â† ä¿å­˜ä¼šè¯æ‘˜è¦
â”‚   â”‚   â””â”€â”€ pre-compact.js        â† å‹ç¼©å‰ä¿å­˜çŠ¶æ€
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ utils.js              â† æ ¸å¿ƒå·¥å…·åº“ï¼ˆæ‰€æœ‰é’©å­ä¾èµ–ï¼‰
â”‚       â”œâ”€â”€ package-manager.js    â† session-start.js ä¾èµ–
â”‚       â””â”€â”€ session-aliases.js    â† session-start.js ä¾èµ–
â””â”€â”€ settings.json                 â† é’©å­é…ç½®æ–‡ä»¶
```

### æœ€å°é…ç½®æ–‡ä»¶

**`~/.claude/settings.json`**ï¼š

```json
{
  "$schema": "https://json.schemastore.org/claude-code-settings.json",
  "hooks": {
    "SessionStart": [
      {
        "matcher": "*",
        "hooks": [{
          "type": "command",
          "command": "node ~/.claude/scripts/hooks/session-start.js"
        }],
        "description": "Load previous session context"
      }
    ],
    "SessionEnd": [
      {
        "matcher": "*",
        "hooks": [{
          "type": "command",
          "command": "node ~/.claude/scripts/hooks/session-end.js"
        }],
        "description": "Save session state"
      }
    ],
    "PreCompact": [
      {
        "matcher": "*",
        "hooks": [{
          "type": "command",
          "command": "node ~/.claude/scripts/hooks/pre-compact.js"
        }],
        "description": "Save state before compaction"
      }
    ]
  }
}
```

### å¯é€‰å¢å¼ºï¼ˆæŒç»­å­¦ä¹ ï¼‰

å¦‚æœéœ€è¦æŒç»­å­¦ä¹ åŠŸèƒ½ï¼Œé¢å¤–æ·»åŠ ï¼š

```json
{
  "hooks": {
    "Stop": [
      {
        "matcher": "*",
        "hooks": [{
          "type": "command",
          "command": "node ~/.claude/scripts/hooks/evaluate-session.js"
        }],
        "description": "Evaluate session for extractable patterns"
      }
    ]
  }
}
```

å¹¶æ·»åŠ é…ç½®æ–‡ä»¶ï¼š
- `~/.claude/skills/continuous-learning/config.json`
- `~/.claude/scripts/hooks/evaluate-session.js`

---

## å®é™…ä½¿ç”¨æµç¨‹

### ç¬¬ä¸€å¤©å·¥ä½œ

```bash
# 1. å¼€å§‹å·¥ä½œ
$ claude

[SessionStart] No recent sessions found
[SessionStart] Package manager: pnpm (detected)

# 2. åšä¸€äº›å·¥ä½œ
You: "å¸®æˆ‘å®ç° JWT è®¤è¯"
Claude: [ä¿®æ”¹æ–‡ä»¶ã€è§£å†³é—®é¢˜...]

# 3. ä¼šè¯ç»“æŸ
You: Ctrl+D

[SessionEnd] Created session file: ~/.claude/sessions/2026-02-15-abc123-session.tmp
[ContinuousLearning] Session has 15 messages - evaluate for extractable patterns
```

**è‡ªåŠ¨ç”Ÿæˆçš„ä¼šè¯æ–‡ä»¶**ï¼š
```markdown
# Session: 2026-02-15

### Tasks
- å¸®æˆ‘å®ç° JWT è®¤è¯
- ä¿®å¤ token è¿‡æœŸçš„ bug
- æ·»åŠ åˆ·æ–° token åŠŸèƒ½

### Files Modified
- src/middleware/auth.js
- src/routes/auth.js
- src/services/token.service.js

### Tools Used
Edit, Write, Bash, Read

### Stats
- Total user messages: 15
```

---

### ç¬¬äºŒå¤©ç»§ç»­

```bash
# 1. å¼€å§‹æ–°ä¼šè¯
$ claude

[SessionStart] Found 1 recent session(s)
[SessionStart] Latest: ~/.claude/sessions/2026-02-15-abc123-session.tmp
[SessionStart] Package manager: pnpm

Previous session summary:
# Session: 2026-02-15

### Tasks
- å¸®æˆ‘å®ç° JWT è®¤è¯
- ä¿®å¤ token è¿‡æœŸçš„ bug
- æ·»åŠ åˆ·æ–° token åŠŸèƒ½

### Files Modified
- src/middleware/auth.js
- src/routes/auth.js
- src/services/token.service.js

# 2. Claude è‡ªåŠ¨çŸ¥é“ä¸Šä¸‹æ–‡
You: "ç»§ç»­å®Œæˆé€Ÿç‡é™åˆ¶åŠŸèƒ½"
Claude: "æ ¹æ®æ˜¨å¤©çš„å·¥ä½œï¼Œæˆ‘çœ‹åˆ°ä½ å·²ç»å®Œæˆäº† JWT è®¤è¯çš„åŸºç¡€éƒ¨åˆ†ã€‚
       ç°åœ¨æˆ‘å°†åœ¨ src/routes/auth.js ä¸­æ·»åŠ é€Ÿç‡é™åˆ¶..."
```

**å…³é”®ä¼˜åŠ¿**ï¼š
- âœ… Claude çŸ¥é“æ˜¨å¤©åšäº†ä»€ä¹ˆ
- âœ… Claude çŸ¥é“å“ªäº›æ–‡ä»¶è¢«ä¿®æ”¹è¿‡
- âœ… Claude çŸ¥é“ä½¿ç”¨äº†å“ªäº›å·¥å…·
- âœ… æ— éœ€é‡å¤è§£é‡Šä¸Šä¸‹æ–‡

---

### é‡åˆ°ç›¸åŒé—®é¢˜ç¬¬ä¸‰æ¬¡

```bash
# ç¬¬ä¸€æ¬¡ï¼šæ‰‹åŠ¨è§£å†³
You: "ä¸ºä»€ä¹ˆ JWT token ç«‹å³è¿‡æœŸï¼Ÿ"
Claude: "æ£€æŸ¥ expiresIn å‚æ•°..."

# ç¬¬äºŒæ¬¡ï¼šå†æ¬¡æ‰‹åŠ¨è§£å†³
You: "åˆé‡åˆ° token è¿‡æœŸé—®é¢˜..."
Claude: "æ£€æŸ¥ expiresIn å‚æ•°..."

# ç¬¬ä¸‰æ¬¡ï¼šè‡ªåŠ¨å­¦ä¹ 
[ContinuousLearning] Detected repeated pattern: jwt-expiry-bug
[ContinuousLearning] Saved to ~/.claude/skills/learned/jwt-expiry-bug.md

# ç¬¬å››æ¬¡ï¼šè‡ªåŠ¨åŠ è½½ skill
$ claude
[SessionStart] 6 learned skill(s) available
You: "JWT token è¿‡æœŸé—®é¢˜"
Claude: "æ ¹æ®ä¹‹å‰å­¦åˆ°çš„æ¨¡å¼ï¼Œè¿™é€šå¸¸æ˜¯å› ä¸º expiresIn ä¼ å…¥äº†æ¯«ç§’è€Œä¸æ˜¯ç§’ã€‚
       åº”è¯¥ä½¿ç”¨å­—ç¬¦ä¸²æ ¼å¼ï¼šexpiresIn: '15m' ..."
```

---

## æ ¸å¿ƒä»£ç è§£æ

### utils.js - æ ¸å¿ƒå·¥å…·åº“

**æ–‡ä»¶è·¯å¾„**ï¼š`scripts/lib/utils.js` (530 è¡Œ)

**å…³é”®è®¾è®¡ç†å¿µ**ï¼š
- è·¨å¹³å°å…¼å®¹ï¼ˆWindows, macOS, Linuxï¼‰
- çº¯ Node.js æ ‡å‡†åº“ï¼ˆæ— å¤–éƒ¨ä¾èµ–ï¼‰
- é”™è¯¯å®‰å…¨ï¼ˆæ‰€æœ‰æ“ä½œéƒ½æœ‰ try-catchï¼‰

**æ ¸å¿ƒå‡½æ•°åˆ†ç»„**ï¼š

#### 1. ç›®å½•ç®¡ç†
```javascript
// è·å–ç”¨æˆ·ä¸»ç›®å½•ï¼ˆè·¨å¹³å°ï¼‰
function getHomeDir() {
  return os.homedir();  // Windows: C:\Users\xxx, Mac/Linux: /home/xxx
}

// è·å– Claude é…ç½®ç›®å½•
function getClaudeDir() {
  return path.join(getHomeDir(), '.claude');  // ~/.claude
}

// è·å–ä¼šè¯å­˜å‚¨ç›®å½•
function getSessionsDir() {
  return path.join(getClaudeDir(), 'sessions');  // ~/.claude/sessions
}

// è·å–å­¦ä¹ æŠ€èƒ½ç›®å½•
function getLearnedSkillsDir() {
  return path.join(getClaudeDir(), 'skills', 'learned');
}

// ç¡®ä¿ç›®å½•å­˜åœ¨ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
function ensureDir(dirPath) {
  try {
    if (!fs.existsSync(dirPath)) {
      fs.mkdirSync(dirPath, { recursive: true });
    }
  } catch (err) {
    if (err.code !== 'EEXIST') {
      throw new Error(`Failed to create directory '${dirPath}': ${err.message}`);
    }
  }
  return dirPath;
}
```

#### 2. æ—¥æœŸæ—¶é—´
```javascript
// YYYY-MM-DD æ ¼å¼
function getDateString() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// HH:MM æ ¼å¼
function getTimeString() {
  const now = new Date();
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  return `${hours}:${minutes}`;
}

// YYYY-MM-DD HH:MM:SS æ ¼å¼
function getDateTimeString() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const seconds = String(now.getSeconds()).padStart(2, '0');
  return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}
```

#### 3. æ–‡ä»¶æ“ä½œ
```javascript
// å®‰å…¨è¯»å–æ–‡ä»¶ï¼ˆå¤±è´¥è¿”å› nullï¼‰
function readFile(filePath) {
  try {
    return fs.readFileSync(filePath, 'utf8');
  } catch {
    return null;
  }
}

// å†™å…¥æ–‡ä»¶ï¼ˆè‡ªåŠ¨åˆ›å»ºçˆ¶ç›®å½•ï¼‰
function writeFile(filePath, content) {
  ensureDir(path.dirname(filePath));
  fs.writeFileSync(filePath, content, 'utf8');
}

// è¿½åŠ åˆ°æ–‡ä»¶
function appendFile(filePath, content) {
  ensureDir(path.dirname(filePath));
  fs.appendFileSync(filePath, content, 'utf8');
}

// æ›¿æ¢æ–‡ä»¶å†…å®¹
function replaceInFile(filePath, search, replace, options = {}) {
  const content = readFile(filePath);
  if (content === null) return false;

  try {
    let newContent;
    if (options.all && typeof search === 'string') {
      newContent = content.replaceAll(search, replace);
    } else {
      newContent = content.replace(search, replace);
    }
    writeFile(filePath, newContent);
    return true;
  } catch (err) {
    log(`[Utils] replaceInFile failed for ${filePath}: ${err.message}`);
    return false;
  }
}
```

#### 4. æ–‡ä»¶æŸ¥æ‰¾ï¼ˆè·¨å¹³å° find æ›¿ä»£ï¼‰
```javascript
/**
 * æŸ¥æ‰¾åŒ¹é…æ¨¡å¼çš„æ–‡ä»¶
 * @param {string} dir - æœç´¢ç›®å½•
 * @param {string} pattern - æ–‡ä»¶æ¨¡å¼ï¼ˆå¦‚ "*.tmp", "*.md"ï¼‰
 * @param {object} options - é€‰é¡¹ { maxAge: å¤©æ•°, recursive: å¸ƒå°”å€¼ }
 */
function findFiles(dir, pattern, options = {}) {
  const { maxAge = null, recursive = false } = options;
  const results = [];

  // å°† glob æ¨¡å¼è½¬æ¢ä¸ºæ­£åˆ™è¡¨è¾¾å¼
  const regexPattern = pattern
    .replace(/[.+^${}()|[\]\\]/g, '\\$&')  // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
    .replace(/\*/g, '.*')                   // * â†’ .*
    .replace(/\?/g, '.');                   // ? â†’ .
  const regex = new RegExp(`^${regexPattern}$`);

  function searchDir(currentDir) {
    try {
      const entries = fs.readdirSync(currentDir, { withFileTypes: true });

      for (const entry of entries) {
        const fullPath = path.join(currentDir, entry.name);

        if (entry.isFile() && regex.test(entry.name)) {
          const stats = fs.statSync(fullPath);

          // å¦‚æœæŒ‡å®šäº† maxAgeï¼Œæ£€æŸ¥æ–‡ä»¶å¹´é¾„
          if (maxAge !== null) {
            const ageInDays = (Date.now() - stats.mtimeMs) / (1000 * 60 * 60 * 24);
            if (ageInDays <= maxAge) {
              results.push({ path: fullPath, mtime: stats.mtimeMs });
            }
          } else {
            results.push({ path: fullPath, mtime: stats.mtimeMs });
          }
        } else if (entry.isDirectory() && recursive) {
          searchDir(fullPath);
        }
      }
    } catch (_err) {
      // å¿½ç•¥æƒé™é”™è¯¯
    }
  }

  searchDir(dir);

  // æŒ‰ä¿®æ”¹æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
  results.sort((a, b) => b.mtime - a.mtime);

  return results;
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```javascript
// æŸ¥æ‰¾æœ€è¿‘ 7 å¤©çš„ä¼šè¯æ–‡ä»¶
const recentSessions = findFiles(
  '~/.claude/sessions',
  '*-session.tmp',
  { maxAge: 7 }
);
// è¿”å›ï¼š[
//   { path: '~/.claude/sessions/2026-02-15-abc123-session.tmp', mtime: 1708012800000 },
//   { path: '~/.claude/sessions/2026-02-14-xyz789-session.tmp', mtime: 1707926400000 }
// ]
```

#### 5. é’©å­ I/O
```javascript
// è¾“å‡ºåˆ° stderrï¼ˆç”¨æˆ·å¯è§çš„æ—¥å¿—ï¼‰
function log(message) {
  console.error(message);
}

// è¾“å‡ºåˆ° stdoutï¼ˆä¼ é€’ç»™ Claudeï¼‰
function output(data) {
  if (typeof data === 'object') {
    console.log(JSON.stringify(data));
  } else {
    console.log(data);
  }
}
```

**å…³é”®åŒºåˆ«**ï¼š
- `log()` â†’ stderr â†’ ç”¨æˆ·åœ¨ç»ˆç«¯çœ‹åˆ°
- `output()` â†’ stdout â†’ Claude æ¥æ”¶åˆ°ï¼ˆæˆä¸ºä¸Šä¸‹æ–‡çš„ä¸€éƒ¨åˆ†ï¼‰

---

### session-end.js - ä¼šè¯æ‘˜è¦ç”Ÿæˆ

**æ ¸å¿ƒé€»è¾‘**ï¼šè§£æ JSONL è½¬å½•æ–‡ä»¶ï¼Œæå–å…³é”®ä¿¡æ¯

```javascript
function extractSessionSummary(transcriptPath) {
  const content = readFile(transcriptPath);
  if (!content) return null;

  const lines = content.split('\n').filter(Boolean);
  const userMessages = [];
  const toolsUsed = new Set();
  const filesModified = new Set();

  for (const line of lines) {
    try {
      const entry = JSON.parse(line);

      // 1. æ”¶é›†ç”¨æˆ·æ¶ˆæ¯
      if (entry.type === 'user' || entry.role === 'user') {
        const rawContent = entry.message?.content ?? entry.content;
        const text = typeof rawContent === 'string'
          ? rawContent
          : Array.isArray(rawContent)
            ? rawContent.map(c => (c && c.text) || '').join(' ')
            : '';
        if (text.trim()) {
          userMessages.push(text.trim().slice(0, 200));  // æ¯æ¡æœ€å¤š 200 å­—ç¬¦
        }
      }

      // 2. æ”¶é›†å·¥å…·ä½¿ç”¨
      if (entry.type === 'tool_use' || entry.tool_name) {
        const toolName = entry.tool_name || entry.name || '';
        if (toolName) toolsUsed.add(toolName);

        // 3. æ”¶é›†æ–‡ä»¶ä¿®æ”¹ï¼ˆä»… Edit/Write å·¥å…·ï¼‰
        const filePath = entry.tool_input?.file_path || entry.input?.file_path || '';
        if (filePath && (toolName === 'Edit' || toolName === 'Write')) {
          filesModified.add(filePath);
        }
      }

      // 4. å¤„ç†åµŒå¥—çš„ tool_useï¼ˆassistant æ¶ˆæ¯ä¸­çš„ content blocksï¼‰
      if (entry.type === 'assistant' && Array.isArray(entry.message?.content)) {
        for (const block of entry.message.content) {
          if (block.type === 'tool_use') {
            const toolName = block.name || '';
            if (toolName) toolsUsed.add(toolName);

            const filePath = block.input?.file_path || '';
            if (filePath && (toolName === 'Edit' || toolName === 'Write')) {
              filesModified.add(filePath);
            }
          }
        }
      }
    } catch {
      // è·³è¿‡æ— æ³•è§£æçš„è¡Œ
    }
  }

  if (userMessages.length === 0) return null;

  return {
    userMessages: userMessages.slice(-10),          // æœ€å 10 æ¡
    toolsUsed: Array.from(toolsUsed).slice(0, 20),  // æœ€å¤š 20 ä¸ª
    filesModified: Array.from(filesModified).slice(0, 30),  // æœ€å¤š 30 ä¸ª
    totalMessages: userMessages.length
  };
}
```

**ç”Ÿæˆæ‘˜è¦æ¨¡æ¿**ï¼š

```javascript
function buildSummarySection(summary) {
  let section = '## Session Summary\n\n';

  // ä»»åŠ¡åˆ—è¡¨
  section += '### Tasks\n';
  for (const msg of summary.userMessages) {
    section += `- ${msg.replace(/\n/g, ' ').replace(/`/g, '\\`')}\n`;
  }
  section += '\n';

  // ä¿®æ”¹çš„æ–‡ä»¶
  if (summary.filesModified.length > 0) {
    section += '### Files Modified\n';
    for (const f of summary.filesModified) {
      section += `- ${f}\n`;
    }
    section += '\n';
  }

  // ä½¿ç”¨çš„å·¥å…·
  if (summary.toolsUsed.length > 0) {
    section += `### Tools Used\n${summary.toolsUsed.join(', ')}\n\n`;
  }

  // ç»Ÿè®¡ä¿¡æ¯
  section += `### Stats\n- Total user messages: ${summary.totalMessages}\n`;

  return section;
}
```

---

## æ€»ç»“

### æœ€å°å¿…éœ€æ–‡ä»¶ï¼ˆ6 ä¸ªï¼‰

```
~/.claude/scripts/
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ session-start.js      (60 è¡Œ)
â”‚   â”œâ”€â”€ session-end.js        (235 è¡Œ)
â”‚   â””â”€â”€ pre-compact.js        (49 è¡Œ)
â””â”€â”€ lib/
    â”œâ”€â”€ utils.js              (530 è¡Œ)
    â”œâ”€â”€ package-manager.js    (çº¦ 300 è¡Œ)
    â””â”€â”€ session-aliases.js    (çº¦ 300 è¡Œ)
```

**æ€»ä»£ç é‡**ï¼šçº¦ 1500 è¡Œ
**æ ¸å¿ƒä»£ç **ï¼šçº¦ 800 è¡Œï¼ˆ3 ä¸ªé’©å­ + utils.jsï¼‰

### æ ¸å¿ƒä»·å€¼

1. **è‡ªåŠ¨åŒ–è®°å¿†** - æ— éœ€æ‰‹åŠ¨è®°å½•ï¼Œä¼šè¯ç»“æŸè‡ªåŠ¨ä¿å­˜
2. **æ— ç¼æ¢å¤** - æ–°ä¼šè¯è‡ªåŠ¨åŠ è½½ä¸Šä¸‹æ–‡ï¼Œæ— éœ€é‡æ–°è§£é‡Š
3. **é¿å…é‡å¤** - è®°å½•å¤±è´¥çš„æ–¹æ³•ï¼Œé¿å…é‡å¤çŠ¯é”™
4. **æŒç»­å­¦ä¹ ** - å°†é‡å¤æ¨¡å¼è½¬åŒ–ä¸ºå¯å¤ç”¨ skills
5. **é›¶å»¶è¿Ÿ** - ä½¿ç”¨ Stop Hookï¼Œä¸å½±å“äº¤äº’æ€§èƒ½

### å…³é”®è®¾è®¡ç†å¿µ

- **è½»é‡çº§**ï¼šçº¯ Node.js æ ‡å‡†åº“ï¼Œæ— å¤–éƒ¨ä¾èµ–
- **è·¨å¹³å°**ï¼šWindowsã€macOSã€Linux å®Œå…¨å…¼å®¹
- **éé˜»å¡**ï¼šStop Hook åœ¨ä¼šè¯ç»“æŸè¿è¡Œï¼Œä¸å¢åŠ å»¶è¿Ÿ
- **å¯é…ç½®**ï¼šå¯åœ¨ settings.json ä¸­è‡ªå®šä¹‰é’©å­è¡Œä¸º
- **æ¸è¿›å¼**ï¼šæœ€å° 3 ä¸ªé’©å­å³å¯å·¥ä½œï¼Œå¯é€æ­¥æ·»åŠ åŠŸèƒ½

---

## ç›¸å…³èµ„æº

- **GitHub Repo**ï¼šhttps://github.com/affaan-m/everything-claude-code
- **é•¿ç¯‡æŒ‡å—**ï¼š`the-longform-guide.md`
- **çŸ­ç¯‡æŒ‡å—**ï¼š`the-shortform-guide.md`
- **ä¼šè¯ç¤ºä¾‹**ï¼š`examples/sessions/`
- **é’©å­æ–‡æ¡£**ï¼š`hooks/README.md`

---

**æœ€åæ›´æ–°**ï¼š2026-02-16
**åˆ†æä½œè€…**ï¼šClaude Sonnet 4.5 (AI Assistant)
**åŸºäºç‰ˆæœ¬**ï¼ševerything-claude-code commit abc123
