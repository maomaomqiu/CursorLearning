# Strategic Compact Skill å®Œæ•´åˆ†æ

> Everything Claude Code - Strategic Compact Skill æ·±åº¦è§£æ

**ç”Ÿæˆæ—¶é—´**: 2026-02-17 21:05:56
**åŸæ–‡æ¥æº**: `github.com/affaan-m/everything-claude-code`
**åˆ†æèŒƒå›´**: ä»£ç å®ç°ã€é…ç½®ã€æµ‹è¯•ã€æ–‡æ¡£å¼•ç”¨

---

## â“ å¿«é€Ÿé—®ç­”

**Q: è¿™ä¸ª skill æ˜¯è‡ªåŠ¨è§¦å‘çš„å—ï¼Ÿ**

**A: ç®€çŸ­å›ç­”**:
- âœ… **å»ºè®®æ˜¯è‡ªåŠ¨çš„** - Hook ä¼šè‡ªåŠ¨è¿½è¸ªå¹¶åœ¨åˆé€‚æ—¶æœºæé†’ä½ 
- âŒ **å‹ç¼©æ˜¯æ‰‹åŠ¨çš„** - éœ€è¦ä½ ä¸»åŠ¨å†³å®šå¹¶æ‰§è¡Œ `/compact`

**ç±»æ¯”**:
```
å°±åƒæ±½è½¦çš„æ²¹é‡è­¦å‘Šç¯ï¼š
ğŸš¨ è­¦å‘Šç¯è‡ªåŠ¨äº®èµ·ï¼ˆè‡ªåŠ¨å»ºè®®ï¼‰
ğŸš— ä½†ä½ éœ€è¦è‡ªå·±å†³å®šä½•æ—¶åŠ æ²¹ï¼ˆæ‰‹åŠ¨å‹ç¼©ï¼‰
```

è¿™ç§è®¾è®¡è®©ä½ ä¿æŒæ§åˆ¶æƒï¼Œåœ¨æœ€åˆé€‚çš„æ—¶æœºå‹ç¼©ï¼Œè€Œä¸æ˜¯è¢«åŠ¨åœ°æ¥å—ä»»æ„æ—¶åˆ»çš„è‡ªåŠ¨å‹ç¼©ã€‚

---

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ–‡ä»¶åˆ†å¸ƒ](#æ–‡ä»¶åˆ†å¸ƒ)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [å®ç°ç»†èŠ‚](#å®ç°ç»†èŠ‚)
- [Hook é…ç½®](#hook-é…ç½®)
- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
- [æµ‹è¯•è¦†ç›–](#æµ‹è¯•è¦†ç›–)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [æ–‡æ¡£å¼•ç”¨](#æ–‡æ¡£å¼•ç”¨)

---

## æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ Strategic Compactï¼Ÿ

Strategic Compact æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–å»ºè®®ç³»ç»Ÿï¼Œåœ¨**é€»è¾‘èŠ‚ç‚¹**æé†’ä½ æ‰‹åŠ¨æ‰§è¡Œ `/compact`ï¼Œè€Œä¸æ˜¯ä¾èµ–åœ¨ä»»æ„æ—¶åˆ»è§¦å‘çš„è‡ªåŠ¨å‹ç¼©ã€‚

### æ ¸å¿ƒé—®é¢˜

**è‡ªåŠ¨å‹ç¼©çš„é—®é¢˜**:
```
âŒ åœ¨ä»»æ„ç‚¹è§¦å‘ï¼Œå¸¸å¸¸åœ¨ä»»åŠ¡ä¸­é€”
âŒ ä¸äº†è§£é€»è¾‘ä»»åŠ¡è¾¹ç•Œ
âŒ å¯èƒ½ä¸­æ–­å¤æ‚çš„å¤šæ­¥éª¤æ“ä½œ
```

**æˆ˜ç•¥æ€§å‹ç¼©çš„ä¼˜åŠ¿**:
```
âœ… åœ¨é€»è¾‘è¾¹ç•Œå‹ç¼©ï¼ˆæ¢ç´¢åã€é‡Œç¨‹ç¢‘åï¼‰
âœ… ä¿ç•™æ‰§è¡Œæ‰€éœ€çš„ä¸Šä¸‹æ–‡
âœ… æ¸…é™¤ä¸å†éœ€è¦çš„æ¢ç´¢ä¸Šä¸‹æ–‡
âœ… ä¸ºæ–°é˜¶æ®µæä¾›æ¸…çˆ½çš„å¼€å§‹
```

### è®¾è®¡ç†å¿µ

> åœ¨æ­£ç¡®çš„æ—¶é—´å‹ç¼©ï¼Œè€Œä¸æ˜¯åœ¨éšæœºçš„æ—¶é—´ã€‚

**å…³é”®æ—¶åˆ»**:
1. **æ¢ç´¢åï¼Œæ‰§è¡Œå‰** - å‹ç¼©ç ”ç©¶ä¸Šä¸‹æ–‡ï¼Œä¿ç•™å®æ–½è®¡åˆ’
2. **å®Œæˆé‡Œç¨‹ç¢‘å** - ä¸ºä¸‹ä¸€é˜¶æ®µæä¾›æ¸…çˆ½å¼€å§‹
3. **é‡å¤§ä¸Šä¸‹æ–‡åˆ‡æ¢å‰** - åœ¨è½¬å‘ä¸åŒä»»åŠ¡å‰æ¸…é™¤æ¢ç´¢ä¸Šä¸‹æ–‡

---

## æ–‡ä»¶åˆ†å¸ƒ

### æ ¸å¿ƒæ–‡ä»¶

```
everything-claude-code/
â”œâ”€â”€ skills/
â”‚   â””â”€â”€ strategic-compact/
â”‚       â”œâ”€â”€ SKILL.md                    â† Skill æ–‡æ¡£ï¼ˆ103 è¡Œï¼‰
â”‚       â””â”€â”€ suggest-compact.sh          â† Bash å®ç°ï¼ˆ55 è¡Œï¼‰
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ hooks/
â”‚       â””â”€â”€ suggest-compact.js          â† Node.js å®ç°ï¼ˆ81 è¡Œï¼‰â­ ç”Ÿäº§ç‰ˆæœ¬
â”‚
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ hooks.json                      â† Hook é…ç½®ï¼ˆç¬¬ 45-54 è¡Œï¼‰
â”‚
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ hooks/
â”‚       â””â”€â”€ suggest-compact.test.js     â† å•å…ƒæµ‹è¯•ï¼ˆ351 è¡Œï¼‰
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ token-optimization.md           â† ä½¿ç”¨æŒ‡å—ï¼ˆç¬¬ 72-78 è¡Œï¼‰
    â””â”€â”€ [å¤šè¯­è¨€ç‰ˆæœ¬]
        â”œâ”€â”€ zh-CN/
        â”œâ”€â”€ zh-TW/
        â””â”€â”€ ja-JP/
```

### å¤šè¯­è¨€æ”¯æŒ

**Skill æ–‡æ¡£**:
- `skills/strategic-compact/SKILL.md` (è‹±æ–‡)
- `docs/zh-CN/skills/strategic-compact/SKILL.md` (ç®€ä½“ä¸­æ–‡)
- `docs/zh-TW/skills/strategic-compact/SKILL.md` (ç¹ä½“ä¸­æ–‡)
- `docs/ja-JP/skills/strategic-compact/SKILL.md` (æ—¥æ–‡)

**å®ç°æ–‡ä»¶**:
- `.cursor/skills/strategic-compact/` (Cursor IDE é›†æˆ)
- `.opencode/` (OpenCode é›†æˆ)

---

## æ ¸å¿ƒåŠŸèƒ½

### åŠŸèƒ½æ¦‚è§ˆ

**ç›®æ ‡**: åœ¨é€»è¾‘èŠ‚ç‚¹å»ºè®®æ‰‹åŠ¨å‹ç¼©ï¼Œé¿å…ä»»æ„è‡ªåŠ¨å‹ç¼©çš„é—®é¢˜

**å·¥ä½œæ–¹å¼**:

```mermaid
graph LR
    A[Edit/Write å·¥å…·è°ƒç”¨] --> B[PreToolUse Hook]
    B --> C[å¢åŠ è®¡æ•°å™¨]
    C --> D{è¾¾åˆ°é˜ˆå€¼?}
    D -->|æ˜¯| E[è¾“å‡ºå»ºè®®]
    D -->|å¦| F{æ˜¯é—´éš”ç‚¹?}
    F -->|æ˜¯| E
    F -->|å¦| G[é™é»˜]
    E --> H[ç»§ç»­æ‰§è¡Œå·¥å…·]
    G --> H
```

### å·¥ä½œæµç¨‹

1. **è¿½è¸ªå·¥å…·è°ƒç”¨** - æ¯æ¬¡ Edit/Write å‰é€’å¢è®¡æ•°å™¨
2. **é˜ˆå€¼æ£€æµ‹** - è¾¾åˆ°å¯é…ç½®é˜ˆå€¼æ—¶å»ºè®®ï¼ˆé»˜è®¤: 50 æ¬¡ï¼‰
3. **å®šæœŸæé†’** - é˜ˆå€¼åæ¯ 25 æ¬¡æé†’ä¸€æ¬¡

### è®¡æ•°å™¨å­˜å‚¨

**ä½ç½®**:
```bash
# Linux/macOS
/tmp/claude-tool-count-{SESSION_ID}

# Windows
%TEMP%\claude-tool-count-{SESSION_ID}
```

**ä¼šè¯éš”ç¦»**:
- ä½¿ç”¨ `CLAUDE_SESSION_ID` ç¯å¢ƒå˜é‡
- æ¯ä¸ªä¼šè¯ç‹¬ç«‹è®¡æ•°
- æœªè®¾ç½®æ—¶å›é€€åˆ° `"default"`

---

## å®ç°ç»†èŠ‚

### Node.js å®ç° (`suggest-compact.js`)

**å…³é”®ä»£ç ç‰‡æ®µ**:

```javascript
// 1. è·å–ä¼šè¯ ID å’Œé˜ˆå€¼
const sessionId = process.env.CLAUDE_SESSION_ID || 'default';
const counterFile = path.join(getTempDir(), `claude-tool-count-${sessionId}`);
const threshold = parseInt(process.env.COMPACT_THRESHOLD || '50', 10);

// 2. è¯»å–æˆ–åˆå§‹åŒ–è®¡æ•°å™¨
let count = 1;
try {
  const fd = fs.openSync(counterFile, 'a+');
  const buf = Buffer.alloc(64);
  const bytesRead = fs.readSync(fd, buf, 0, 64, 0);
  if (bytesRead > 0) {
    const parsed = parseInt(buf.toString('utf8', 0, bytesRead).trim(), 10);
    count = (Number.isFinite(parsed) && parsed > 0 && parsed <= 1000000)
      ? parsed + 1
      : 1;
  }
  fs.ftruncateSync(fd, 0);
  fs.writeSync(fd, String(count), 0);
  fs.closeSync(fd);
} catch {
  writeFile(counterFile, String(count));
}

// 3. å»ºè®®é€»è¾‘
if (count === threshold) {
  log(`[StrategicCompact] ${threshold} tool calls reached - consider /compact if transitioning phases`);
}

if (count > threshold && (count - threshold) % 25 === 0) {
  log(`[StrategicCompact] ${count} tool calls - good checkpoint for /compact if context is stale`);
}
```

**å…³é”®ç‰¹æ€§**:

1. **åŸå­æ–‡ä»¶æ“ä½œ**
   ```javascript
   // ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦å‡å°‘ç«äº‰æ¡ä»¶
   const fd = fs.openSync(counterFile, 'a+');
   fs.readSync(fd, buf, 0, 64, 0);
   fs.ftruncateSync(fd, 0);
   fs.writeSync(fd, String(count), 0);
   fs.closeSync(fd);
   ```

2. **å¥å£®çš„é”™è¯¯å¤„ç†**
   ```javascript
   // æŸåçš„æ–‡ä»¶å†…å®¹ â†’ é‡ç½®ä¸º 1
   count = (Number.isFinite(parsed) && parsed > 0 && parsed <= 1000000)
     ? parsed + 1
     : 1;
   ```

3. **é˜ˆå€¼éªŒè¯**
   ```javascript
   // æœ‰æ•ˆèŒƒå›´: 1-10000
   const threshold = Number.isFinite(rawThreshold) &&
                     rawThreshold > 0 &&
                     rawThreshold <= 10000
     ? rawThreshold
     : 50; // å›é€€åˆ°é»˜è®¤å€¼
   ```

4. **éé˜»å¡è®¾è®¡**
   ```javascript
   process.exit(0); // å§‹ç»ˆè¿”å› 0ï¼Œæ°¸ä¸é˜»å¡ Claude
   ```

### Bash å®ç° (`suggest-compact.sh`)

**ç®€åŒ–ç‰ˆæœ¬**:

```bash
#!/bin/bash

# é…ç½®
SESSION_ID="${CLAUDE_SESSION_ID:-${PPID:-default}}"
COUNTER_FILE="/tmp/claude-tool-count-${SESSION_ID}"
THRESHOLD=${COMPACT_THRESHOLD:-50}

# åˆå§‹åŒ–æˆ–é€’å¢è®¡æ•°å™¨
if [ -f "$COUNTER_FILE" ]; then
  count=$(cat "$COUNTER_FILE")
  count=$((count + 1))
  echo "$count" > "$COUNTER_FILE"
else
  echo "1" > "$COUNTER_FILE"
  count=1
fi

# è¾¾åˆ°é˜ˆå€¼æ—¶å»ºè®®
if [ "$count" -eq "$THRESHOLD" ]; then
  echo "[StrategicCompact] $THRESHOLD tool calls reached - consider /compact if transitioning phases" >&2
fi

# é—´éš”å»ºè®®
if [ "$count" -gt "$THRESHOLD" ] && [ $((count % 25)) -eq 0 ]; then
  echo "[StrategicCompact] $count tool calls - good checkpoint for /compact if context is stale" >&2
fi
```

**ä½¿ç”¨åœºæ™¯**:
- è·¨å¹³å°å…¼å®¹æ€§è¾ƒå·®ï¼ˆWindows æ”¯æŒæœ‰é™ï¼‰
- ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨ Node.js ç‰ˆæœ¬
- Bash ç‰ˆæœ¬é€‚åˆå¿«é€ŸåŸå‹å’Œæµ‹è¯•

---

## Hook é…ç½®

### åœ¨ `hooks.json` ä¸­çš„é…ç½®

**ä½ç½®**: `hooks/hooks.json` ç¬¬ 45-54 è¡Œ

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_PLUGIN_ROOT}/scripts/hooks/suggest-compact.js\""
          }
        ],
        "description": "Suggest manual compaction at logical intervals"
      }
    ]
  }
}
```

**å…³é”®é…ç½®é¡¹**:

| å­—æ®µ | å€¼ | è¯´æ˜ |
|------|------|------|
| **matcher** | `"Edit\|Write"` | ä»…åœ¨ Edit æˆ– Write å·¥å…·å‰è§¦å‘ |
| **type** | `"command"` | æ‰§è¡Œ shell å‘½ä»¤ |
| **command** | `node ...suggest-compact.js` | æ‰§è¡Œ Node.js è„šæœ¬ |
| **description** | æè¿°æ€§æ–‡æœ¬ | Hook ç”¨é€”è¯´æ˜ |

**ç¯å¢ƒå˜é‡å ä½ç¬¦**:
```json
"${CLAUDE_PLUGIN_ROOT}/scripts/hooks/suggest-compact.js"
```
- `${CLAUDE_PLUGIN_ROOT}` åœ¨è¿è¡Œæ—¶æ›¿æ¢ä¸ºæ’ä»¶æ ¹ç›®å½•
- ç¡®ä¿è·¨å®‰è£…ä½ç½®çš„å¯ç§»æ¤æ€§

### ç”¨æˆ·é…ç½®

**åœ¨ `~/.claude/settings.json` ä¸­æ·»åŠ **:

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Edit",
        "hooks": [{
          "type": "command",
          "command": "node ~/.claude/skills/strategic-compact/suggest-compact.js"
        }]
      },
      {
        "matcher": "Write",
        "hooks": [{
          "type": "command",
          "command": "node ~/.claude/skills/strategic-compact/suggest-compact.js"
        }]
      }
    ]
  }
}
```

**ç¯å¢ƒå˜é‡é…ç½®**:

```bash
# åœ¨ ~/.bashrc æˆ– ~/.zshrc ä¸­
export COMPACT_THRESHOLD=30  # é™ä½é˜ˆå€¼åˆ° 30 æ¬¡
```

---

## ä½¿ç”¨æŒ‡å—

### æ¿€æ´»æ—¶æœº

**é€‚ç”¨åœºæ™¯**:
- âœ… è¿è¡Œé•¿ä¼šè¯ï¼Œæ¥è¿‘ä¸Šä¸‹æ–‡é™åˆ¶ï¼ˆ200K+ tokensï¼‰
- âœ… å¤šé˜¶æ®µä»»åŠ¡ï¼ˆç ”ç©¶ â†’ è®¡åˆ’ â†’ å®ç° â†’ æµ‹è¯•ï¼‰
- âœ… åœ¨åŒä¸€ä¼šè¯ä¸­åˆ‡æ¢ä¸ç›¸å…³çš„ä»»åŠ¡
- âœ… å®Œæˆé‡å¤§é‡Œç¨‹ç¢‘åå¼€å§‹æ–°å·¥ä½œ
- âœ… å“åº”å˜æ…¢æˆ–ä¸è¿è´¯ï¼ˆä¸Šä¸‹æ–‡å‹åŠ›ï¼‰

**ä¸é€‚ç”¨åœºæ™¯**:
- âŒ çŸ­ä¼šè¯ï¼ˆ< 1 å°æ—¶ï¼‰
- âŒ å•ä¸€ä¸“æ³¨ä»»åŠ¡
- âŒ é¢‘ç¹çš„å°ç¼–è¾‘
- âŒ æ­£åœ¨è¿›è¡Œå¤æ‚çš„å¤šæ­¥éª¤æ“ä½œ

### å‹ç¼©å†³ç­–è¡¨

| é˜¶æ®µè½¬æ¢ | æ˜¯å¦å‹ç¼©? | åŸå›  |
|---------|----------|------|
| **ç ”ç©¶ â†’ è®¡åˆ’** | âœ… æ˜¯ | ç ”ç©¶ä¸Šä¸‹æ–‡åºå¤§ï¼›è®¡åˆ’æ˜¯ç²¾ç‚¼çš„è¾“å‡º |
| **è®¡åˆ’ â†’ å®ç°** | âœ… æ˜¯ | è®¡åˆ’åœ¨ TodoWrite æˆ–æ–‡ä»¶ä¸­ï¼›é‡Šæ”¾ä¸Šä¸‹æ–‡ç”¨äºä»£ç  |
| **å®ç° â†’ æµ‹è¯•** | âš ï¸ å¯èƒ½ | å¦‚æœæµ‹è¯•å¼•ç”¨æœ€è¿‘ä»£ç åˆ™ä¿ç•™ï¼›åˆ‡æ¢ç„¦ç‚¹åˆ™å‹ç¼© |
| **è°ƒè¯• â†’ æ–°åŠŸèƒ½** | âœ… æ˜¯ | è°ƒè¯•è¿½è¸ªæ±¡æŸ“æ— å…³å·¥ä½œçš„ä¸Šä¸‹æ–‡ |
| **å®ç°ä¸­é€”** | âŒ å¦ | ä¸¢å¤±å˜é‡åã€æ–‡ä»¶è·¯å¾„ã€éƒ¨åˆ†çŠ¶æ€ä»£ä»·é«˜ |
| **å¤±è´¥æ–¹æ³•å** | âœ… æ˜¯ | æ¸…é™¤æ­»èƒ¡åŒæ¨ç†å†å°è¯•æ–°æ–¹æ³• |

### å‹ç¼©åçš„ä¿ç•™/ä¸¢å¤±

**ä¿ç•™çš„å†…å®¹** âœ…:

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **CLAUDE.md æŒ‡ä»¤** | é¡¹ç›®çº§é…ç½®ä¿ç•™ |
| **TodoWrite ä»»åŠ¡åˆ—è¡¨** | ä»»åŠ¡è¿½è¸ªæŒä¹…åŒ– |
| **å†…å­˜æ–‡ä»¶** | `~/.claude/memory/` ä¸­çš„æ–‡ä»¶ |
| **Git çŠ¶æ€** | Commits, branches, å·¥ä½œç›®å½•çŠ¶æ€ |
| **ç£ç›˜ä¸Šçš„æ–‡ä»¶** | æ‰€æœ‰å·²ä¿å­˜çš„ä»£ç å’Œæ–‡æ¡£ |

**ä¸¢å¤±çš„å†…å®¹** âŒ:

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **ä¸­é—´æ¨ç†å’Œåˆ†æ** | æ¢ç´¢è¿‡ç¨‹ä¸­çš„æ€è€ƒ |
| **ä¹‹å‰è¯»å–çš„æ–‡ä»¶å†…å®¹** | éœ€è¦é‡æ–°è¯»å– |
| **å¤šæ­¥éª¤å¯¹è¯ä¸Šä¸‹æ–‡** | å¯¹è¯ç»†èŠ‚è¢«æ‘˜è¦ |
| **å·¥å…·è°ƒç”¨å†å²** | è®¡æ•°å™¨è¢«é‡ç½® |
| **ç»†å¾®çš„ç”¨æˆ·åå¥½** | å£å¤´è¡¨è¾¾çš„åå¥½ |

### å®é™…è¾“å‡ºç¤ºä¾‹

**é¦–æ¬¡è¾¾åˆ°é˜ˆå€¼** (é»˜è®¤ 50 æ¬¡):
```
[StrategicCompact] 50 tool calls reached - consider /compact if transitioning phases
```

**å®šæœŸæé†’** (æ¯ 25 æ¬¡):
```
[StrategicCompact] 75 tool calls - good checkpoint for /compact if context is stale
[StrategicCompact] 100 tool calls - good checkpoint for /compact if context is stale
[StrategicCompact] 125 tool calls - good checkpoint for /compact if context is stale
```

**ç”¨æˆ·å†³ç­–æµç¨‹**:
```
1. çœ‹åˆ°å»ºè®®æ¶ˆæ¯
   â†“
2. è¯„ä¼°å½“å‰é˜¶æ®µ
   - æ˜¯å¦åœ¨é˜¶æ®µè½¬æ¢ç‚¹ï¼Ÿ
   - ä¸Šä¸‹æ–‡æ˜¯å¦é™ˆæ—§ï¼Ÿ
   - æ˜¯å¦å³å°†å¼€å§‹æ–°ä»»åŠ¡ï¼Ÿ
   â†“
3. å†³å®š
   - æ˜¯ï¼šæ‰§è¡Œ /compact
   - å¦ï¼šç»§ç»­å·¥ä½œï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æé†’
```

### é…ç½®ç¤ºä¾‹

**é™ä½é˜ˆå€¼** (é¢‘ç¹å»ºè®®):
```bash
# åœ¨ 30 æ¬¡å·¥å…·è°ƒç”¨åå»ºè®®
export COMPACT_THRESHOLD=30
```

**æé«˜é˜ˆå€¼** (å‡å°‘å¹²æ‰°):
```bash
# åœ¨ 100 æ¬¡å·¥å…·è°ƒç”¨åå»ºè®®
export COMPACT_THRESHOLD=100
```

**æ£€æŸ¥å½“å‰è®¡æ•°**:
```bash
# Linux/macOS
cat /tmp/claude-tool-count-$(echo $CLAUDE_SESSION_ID)

# æˆ–ä½¿ç”¨é»˜è®¤ä¼šè¯
cat /tmp/claude-tool-count-default
```

---

## æµ‹è¯•è¦†ç›–

### æµ‹è¯•æ–‡ä»¶

**ä½ç½®**: `tests/hooks/suggest-compact.test.js` (351 è¡Œ)

**æµ‹è¯•æ¡†æ¶**: è‡ªå®šä¹‰æµ‹è¯•è¿è¡Œå™¨ï¼ˆæ— å¤–éƒ¨ä¾èµ–ï¼‰

### æµ‹è¯•ç”¨ä¾‹åˆ†ç±»

#### 1. åŸºç¡€è®¡æ•°å™¨åŠŸèƒ½

```javascript
âœ… creates counter file on first run
   - é¦–æ¬¡è¿è¡Œåˆ›å»º /tmp/claude-tool-count-{session}
   - åˆå§‹å€¼ä¸º 1

âœ… increments counter on subsequent runs
   - è¿è¡Œ 3 æ¬¡åè®¡æ•°å™¨ = 3
   - éªŒè¯æ–‡ä»¶æŒä¹…åŒ–
```

#### 2. é˜ˆå€¼å»ºè®®

```javascript
âœ… suggests compact at threshold (COMPACT_THRESHOLD=3)
   - è®¾ç½®é˜ˆå€¼ä¸º 3
   - ç¬¬ 3 æ¬¡è°ƒç”¨æ—¶è¾“å‡ºå»ºè®®
   - stderr åŒ…å« "3 tool calls reached"

âœ… does NOT suggest compact before threshold
   - é˜ˆå€¼å‰ä¸è¾“å‡ºä»»ä½•å»ºè®®
   - stderr ä¸åŒ…å« "StrategicCompact"
```

#### 3. é—´éš”å»ºè®®

```javascript
âœ… suggests at threshold + 25 interval
   - é˜ˆå€¼ = 3ï¼Œè®¡æ•° = 28 (3 + 25)
   - è¾“å‡ºå»ºè®®ï¼š"28 tool calls - checkpoint"
   - éªŒè¯ (count - threshold) % 25 === 0 é€»è¾‘
```

#### 4. ç¯å¢ƒå˜é‡å¤„ç†

```javascript
âœ… uses default threshold (50) when COMPACT_THRESHOLD is not set
   - æœªè®¾ç½®ç¯å¢ƒå˜é‡æ—¶ä½¿ç”¨é»˜è®¤å€¼ 50

âœ… ignores invalid COMPACT_THRESHOLD (negative)
   - COMPACT_THRESHOLD=-5 â†’ å›é€€åˆ° 50

âœ… ignores non-numeric COMPACT_THRESHOLD
   - COMPACT_THRESHOLD=abc â†’ å›é€€åˆ° 50

âœ… accepts COMPACT_THRESHOLD=10000 (boundary max)
   - ä¸Šé™ 10000 æ˜¯æœ‰æ•ˆçš„

âœ… rejects COMPACT_THRESHOLD=10001 (falls back to 50)
   - è¶…è¿‡ 10000 â†’ å›é€€åˆ° 50

âœ… rejects float COMPACT_THRESHOLD (e.g. 3.5)
   - parseInt('3.5') = 3 (æœ‰æ•ˆ)
```

#### 5. æŸåçš„è®¡æ•°å™¨æ–‡ä»¶

```javascript
âœ… resets counter on corrupted file content
   - æ–‡ä»¶å†…å®¹ = "not-a-number" â†’ é‡ç½®ä¸º 1

âœ… resets counter on extremely large value
   - æ–‡ä»¶å†…å®¹ = 9999999 (> 1000000) â†’ é‡ç½®ä¸º 1

âœ… handles empty counter file
   - ç©ºæ–‡ä»¶ â†’ ä» 1 å¼€å§‹

âœ… counter value at exact boundary 1000000 is valid
   - 1000000 æ˜¯æœ‰æ•ˆçš„æœ€å¤§å€¼

âœ… counter value at 1000001 is clamped (reset to 1)
   - è¶…è¿‡ 1000000 â†’ é‡ç½®ä¸º 1
```

#### 6. ä¼šè¯éš”ç¦»

```javascript
âœ… uses separate counter files per session ID
   - Session A: è¿è¡Œ 2 æ¬¡ â†’ è®¡æ•° = 2
   - Session B: è¿è¡Œ 1 æ¬¡ â†’ è®¡æ•° = 1
   - äº’ä¸å½±å“

âœ… uses "default" session ID when CLAUDE_SESSION_ID is empty
   - ç©ºå­—ç¬¦ä¸² â†’ ä½¿ç”¨ "default"
```

#### 7. é€€å‡ºä»£ç 

```javascript
âœ… always exits 0 (never blocks Claude)
   - æ‰€æœ‰æƒ…å†µä¸‹éƒ½è¿”å› 0
   - å³ä½¿å‘ç”Ÿé”™è¯¯ä¹Ÿä¸é˜»å¡
```

### æµ‹è¯•ç»Ÿè®¡

**æ€»æµ‹è¯•æ•°**: 19 ä¸ªæµ‹è¯•ç”¨ä¾‹
**è¦†ç›–èŒƒå›´**:
- âœ… æ­£å¸¸æµç¨‹
- âœ… è¾¹ç•Œæ¡ä»¶
- âœ… é”™è¯¯å¤„ç†
- âœ… é…ç½®éªŒè¯
- âœ… ä¼šè¯éš”ç¦»

**è¿è¡Œæµ‹è¯•**:
```bash
cd everything-claude-code
node tests/hooks/suggest-compact.test.js

# è¾“å‡º
=== Testing suggest-compact.js ===

Basic counter functionality:
  âœ“ creates counter file on first run
  âœ“ increments counter on subsequent runs

Threshold suggestion:
  âœ“ suggests compact at threshold (COMPACT_THRESHOLD=3)
  âœ“ does NOT suggest compact before threshold

...

Results: Passed: 19, Failed: 0
```

---

## æœ€ä½³å®è·µ

### 1. è®¡åˆ’åå‹ç¼©

**åœºæ™¯**: å®Œæˆæ¢ç´¢å’Œè®¡åˆ’é˜¶æ®µ

```markdown
## å·¥ä½œæµç¨‹

1. æ¢ç´¢ä»£ç åº“ï¼ˆå¤§é‡ Readã€Grep è°ƒç”¨ï¼‰
   â†’ ä¸Šä¸‹æ–‡å……æ»¡äº†æ–‡ä»¶å†…å®¹å’Œæœç´¢ç»“æœ

2. åˆ›å»ºè®¡åˆ’ï¼ˆTodoWrite æˆ– plan.mdï¼‰
   â†’ è®¡åˆ’æ˜¯æ¢ç´¢çš„ç²¾ç‚¼è¾“å‡º

3. **æ‰§è¡Œ /compact**
   â†’ æ¸…é™¤æ¢ç´¢ä¸Šä¸‹æ–‡
   â†’ ä¿ç•™è®¡åˆ’æ–‡æ¡£
   â†’ ä¸ºå®ç°é˜¶æ®µæä¾›æ¸…çˆ½çš„ä¸Šä¸‹æ–‡

4. å¼€å§‹å®ç°
   â†’ ä»æ¸…çˆ½çš„ä¸Šä¸‹æ–‡å¼€å§‹
   â†’ åªåŠ è½½å®ç°æ‰€éœ€çš„æ–‡ä»¶
```

**å‘½ä»¤ç¤ºä¾‹**:
```bash
/compact Focus on implementing auth middleware based on plan.md
```

### 2. è°ƒè¯•åå‹ç¼©

**åœºæ™¯**: å®Œæˆ bug ä¿®å¤ï¼Œå‡†å¤‡ç»§ç»­æ–°å·¥ä½œ

```markdown
## è°ƒè¯•ä¼šè¯

1. é‡åˆ° Bugï¼ˆé”™è¯¯æ—¥å¿—ã€å †æ ˆè¿½è¸ªï¼‰
   â†’ ä¸Šä¸‹æ–‡å……æ»¡äº†é”™è¯¯ä¿¡æ¯

2. è°ƒè¯•è¿‡ç¨‹ï¼ˆå¤šæ¬¡ Readã€Editã€æµ‹è¯•ï¼‰
   â†’ ä¸Šä¸‹æ–‡åŒ…å«å¤±è´¥çš„å°è¯•

3. ä¿®å¤å®Œæˆï¼ˆæµ‹è¯•é€šè¿‡ï¼‰
   âœ… Bug å·²è§£å†³

4. **æ‰§è¡Œ /compact**
   â†’ æ¸…é™¤è°ƒè¯•è¿½è¸ª
   â†’ æ¸…é™¤å¤±è´¥çš„å°è¯•
   â†’ ä¸ºæ–°åŠŸèƒ½æä¾›æ¸…çˆ½çš„ä¸Šä¸‹æ–‡

5. ç»§ç»­æ–°åŠŸèƒ½å¼€å‘
```

### 3. å®ç°ä¸­ä¸å‹ç¼©

**åœºæ™¯**: æ­£åœ¨è¿›è¡Œç›¸å…³çš„ä»£ç æ›´æ”¹

```markdown
## ä¸ºä»€ä¹ˆä¸å‹ç¼©ï¼Ÿ

âŒ ä¸¢å¤±å˜é‡åå’Œç±»å‹
âŒ ä¸¢å¤±æ–‡ä»¶è·¯å¾„å’Œç»“æ„
âŒ ä¸¢å¤±éƒ¨åˆ†å®Œæˆçš„é€»è¾‘
âŒ ä¸¢å¤±ç›¸å…³æ–‡ä»¶çš„ä¸Šä¸‹æ–‡

âœ… ä¿ç•™è¿™äº›ä¿¡æ¯ç›´åˆ°ä»»åŠ¡å®Œæˆ
```

### 4. é˜…è¯»å»ºè®®ï¼Œè‡ªä¸»å†³ç­–

**Hook çš„è§’è‰²**:
- ğŸ“Š æä¾›æ•°æ®ï¼ˆå·¥å…·è°ƒç”¨æ¬¡æ•°ï¼‰
- ğŸ’¡ æå‡ºå»ºè®®ï¼ˆ"è€ƒè™‘å‹ç¼©"ï¼‰
- â±ï¸ æ ‡è®°æ—¶é—´ç‚¹ï¼ˆé€»è¾‘é—´éš”ï¼‰

**ä½ çš„è§’è‰²**:
- ğŸ¤” è¯„ä¼°å½“å‰é˜¶æ®µ
- ğŸ“‹ æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
- ğŸ¯ å†³å®šæ˜¯å¦å‹ç¼©
- â­ï¸ æˆ–æ¨è¿Ÿåˆ°æ›´åˆé€‚çš„æ—¶æœº

### 5. å‹ç¼©å‰ä¿å­˜é‡è¦ä¸Šä¸‹æ–‡

**ä¿å­˜åˆ°æ–‡ä»¶**:
```bash
# ä¿å­˜å½“å‰æ¨ç†
/compact Remember: We're using JWT RS256, keys in env vars, 15min expiry

# æˆ–ä¿å­˜åˆ°æ–‡ä»¶
"å°†å½“å‰çš„å…³é”®å†³ç­–å†™å…¥ decisions.md"
[Claude å†™å…¥æ–‡ä»¶]
/compact
```

**ä¿å­˜åˆ°å†…å­˜**:
```bash
# ä½¿ç”¨å†…å­˜æ–‡ä»¶
echo "Key decisions from this session" > ~/.claude/memory/auth-decisions.md
/compact
```

### 6. ä½¿ç”¨å¸¦æ‘˜è¦çš„ /compact

**è¯­æ³•**:
```bash
/compact [å¯é€‰æ‘˜è¦]
```

**ç¤ºä¾‹**:

```bash
# åŸºç¡€å‹ç¼©
/compact

# å¸¦æ–¹å‘çš„å‹ç¼©
/compact Focus on implementing auth middleware next

# å¸¦ä¸Šä¸‹æ–‡çš„å‹ç¼©
/compact Auth module complete. Next: rate limiting for login endpoints

# å¸¦å†³ç­–çš„å‹ç¼©
/compact Using RS256 JWT, 15min expiry. Now implementing token refresh
```

**æ‘˜è¦çš„ä½œç”¨**:
- ğŸ“ ä¸ºä¸‹ä¸€é˜¶æ®µè®¾å®šæ–¹å‘
- ğŸ§­ æä¾›ä¸Šä¸‹æ–‡æç¤º
- ğŸ“Œ æ ‡è®°å…³é”®å†³ç­–
- ğŸ”— è¿æ¥å‰åé˜¶æ®µ

---

## æ–‡æ¡£å¼•ç”¨

### åœ¨ `the-longform-guide.md` ä¸­

**ä½ç½®**: ç¬¬ 50-52 è¡Œ

```markdown
**Clearing Context Strategically:**

Once you have your plan set and context cleared (default option in plan mode
in Claude Code now), you can work from the plan. This is useful when you've
accumulated a lot of exploration context that's no longer relevant to execution.
For strategic compacting, disable auto compact. Manually compact at logical
intervals or create a skill that does so for you.
```

**è¦ç‚¹**:
- è®¡åˆ’æ¨¡å¼åæ¸…ç†ä¸Šä¸‹æ–‡æ˜¯é»˜è®¤é€‰é¡¹
- æ¢ç´¢ä¸Šä¸‹æ–‡åœ¨æ‰§è¡Œæ—¶ä¸å†ç›¸å…³
- ç¦ç”¨è‡ªåŠ¨å‹ç¼©ï¼Œä½¿ç”¨æˆ˜ç•¥æ€§å‹ç¼©
- å¯ä»¥åˆ›å»º skill è‡ªåŠ¨åŒ–å»ºè®®

---

### åœ¨ `docs/token-optimization.md` ä¸­

**ä½ç½®**: ç¬¬ 72-78 è¡Œ

**å®Œæ•´ç« èŠ‚**:

```markdown
### Strategic compaction

The `strategic-compact` skill (in `skills/strategic-compact/`) suggests
`/compact` at logical intervals rather than relying on auto-compaction,
which can trigger mid-task. See the skill's README for hook setup instructions.

**When to compact:**
- After exploration, before implementation
- After completing a milestone
- After debugging, before continuing with new work
```

**è¦ç‚¹**:
- Skill ä½ç½®ï¼š`skills/strategic-compact/`
- ç›®çš„ï¼šåœ¨é€»è¾‘é—´éš”å»ºè®®å‹ç¼©
- é—®é¢˜ï¼šè‡ªåŠ¨å‹ç¼©å¯èƒ½åœ¨ä»»åŠ¡ä¸­é€”è§¦å‘
- æ—¶æœºï¼šæ¢ç´¢åã€é‡Œç¨‹ç¢‘åã€è°ƒè¯•å

---

### åœ¨ `hooks/README.md` ä¸­

**ä½ç½®**: ç¬¬ 27 è¡Œï¼ˆPreToolUse Hooks è¡¨æ ¼ï¼‰

```markdown
| Hook | Matcher | Behavior | Exit Code |
|------|---------|----------|-----------|
| **Strategic compact** | `Edit\|Write` | Suggests manual `/compact` at logical intervals (every ~50 tool calls) | 0 (warns) |
```

**è¦ç‚¹**:
- ä½œä¸º PreToolUse Hook ç¤ºä¾‹åˆ—å‡º
- åŒ¹é… Edit å’Œ Write å·¥å…·
- é»˜è®¤é—´éš”ï¼šçº¦ 50 æ¬¡å·¥å…·è°ƒç”¨
- é€€å‡ºä»£ç ï¼š0ï¼ˆè­¦å‘Šï¼Œä¸é˜»å¡ï¼‰

---

### åœ¨ README.md ä¸­

**å¤šå¤„æåŠ**:

1. **Skills åˆ—è¡¨**:
   ```markdown
   - **strategic-compact**: Suggests manual context compaction at logical intervals
   ```

2. **Token Optimization ç« èŠ‚**:
   ```markdown
   See `docs/token-optimization.md` for detailed guidance on strategic compaction
   ```

3. **Quick Start ç¤ºä¾‹**:
   ```markdown
   # Install hooks including strategic-compact
   npm run setup:hooks
   ```

---

## ç›¸å…³æŠ€èƒ½å’Œå·¥å…·

### é…åˆä½¿ç”¨çš„åŠŸèƒ½

**1. Memory Persistence Hooks**
```markdown
strategic-compact (å‹ç¼©å»ºè®®)
    â†“ é…åˆ
PreCompact Hook (å‹ç¼©å‰ä¿å­˜çŠ¶æ€)
    â†“ é…åˆ
SessionStart Hook (æ–°ä¼šè¯åŠ è½½ä¸Šä¸‹æ–‡)
```

**2. Continuous Learning**
```markdown
strategic-compact (æ¸…é™¤é™ˆæ—§ä¸Šä¸‹æ–‡)
    â†“ é‡Šæ”¾ç©ºé—´
continuous-learning (æå–å¯å¤ç”¨æ¨¡å¼)
    â†“ ä¿å­˜åˆ°
~/.claude/skills/learned/
```

**3. Plan Mode**
```markdown
Plan Mode (ç”Ÿæˆè®¡åˆ’)
    â†“ è®¡åˆ’å®Œæˆ
strategic-compact (å»ºè®®å‹ç¼©)
    â†“ æ‰§è¡Œ
/compact (æ¸…é™¤æ¢ç´¢ä¸Šä¸‹æ–‡)
    â†“ å¼€å§‹
Implementation (ä»æ¸…çˆ½ä¸Šä¸‹æ–‡æ‰§è¡Œ)
```

### å‘½ä»¤å‚è€ƒ

**Claude Code å‘½ä»¤**:
```bash
/compact              # æ‰‹åŠ¨å‹ç¼©ä¸Šä¸‹æ–‡
/clear                # å®Œå…¨æ¸…é™¤å¯¹è¯å†å²
/cost                 # æŸ¥çœ‹ä¼šè¯ token ä½¿ç”¨é‡
```

**ç¯å¢ƒå˜é‡**:
```bash
COMPACT_THRESHOLD     # é¦–æ¬¡å»ºè®®å‰çš„å·¥å…·è°ƒç”¨æ¬¡æ•°ï¼ˆé»˜è®¤: 50ï¼‰
CLAUDE_SESSION_ID     # ä¼šè¯ IDï¼ˆç”¨äºè®¡æ•°å™¨éš”ç¦»ï¼‰
```

**æ–‡ä»¶è·¯å¾„**:
```bash
# è®¡æ•°å™¨æ–‡ä»¶
/tmp/claude-tool-count-{SESSION_ID}

# Skill å®‰è£…ä½ç½®
~/.claude/skills/strategic-compact/

# Hook è„šæœ¬
~/.claude/scripts/hooks/suggest-compact.js
```

---

## æ€»ç»“

### æ ¸å¿ƒä»·å€¼

**Strategic Compact Skill è§£å†³çš„é—®é¢˜**:

1. âŒ **ä»»æ„è‡ªåŠ¨å‹ç¼©**
   - åœ¨ä»»åŠ¡ä¸­é€”è§¦å‘
   - ä¸¢å¤±å…³é”®ä¸Šä¸‹æ–‡
   - ä¸­æ–­å·¥ä½œæµç¨‹

2. âœ… **æˆ˜ç•¥æ€§æ‰‹åŠ¨å‹ç¼©**
   - åœ¨é€»è¾‘è¾¹ç•Œå»ºè®®
   - ä¿ç•™æ‰§è¡Œæ‰€éœ€ä¸Šä¸‹æ–‡
   - æ¸…é™¤ä¸å†éœ€è¦çš„æ¢ç´¢ä¸Šä¸‹æ–‡

### å®æ–½æ­¥éª¤

**æœ€å°è®¾ç½®**:

1. **å¤åˆ¶ Hook è„šæœ¬**
   ```bash
   cp scripts/hooks/suggest-compact.js ~/.claude/scripts/hooks/
   ```

2. **é…ç½® Hook**
   ```json
   {
     "hooks": {
       "PreToolUse": [{
         "matcher": "Edit|Write",
         "hooks": [{"type": "command", "command": "node ~/.claude/scripts/hooks/suggest-compact.js"}]
       }]
     }
   }
   ```

3. **å¼€å§‹ä½¿ç”¨**
   - Hook ä¼šè‡ªåŠ¨è¿½è¸ªå·¥å…·è°ƒç”¨
   - è¾¾åˆ° 50 æ¬¡æ—¶æ”¶åˆ°å»ºè®®
   - æ ¹æ®é˜¶æ®µå†³å®šæ˜¯å¦å‹ç¼©

**å¯é€‰é…ç½®**:

```bash
# è°ƒæ•´é˜ˆå€¼
export COMPACT_THRESHOLD=30

# æ£€æŸ¥å½“å‰è®¡æ•°
cat /tmp/claude-tool-count-default
```

### æœ€ä½³å®è·µæ€»ç»“

1. âœ… **è®¡åˆ’åå‹ç¼©** - æ¸…é™¤æ¢ç´¢ï¼Œä¿ç•™è®¡åˆ’
2. âœ… **è°ƒè¯•åå‹ç¼©** - æ¸…é™¤é”™è¯¯è¿½è¸ª
3. âŒ **å®ç°ä¸­ä¸å‹ç¼©** - ä¿ç•™å˜é‡åå’Œæ–‡ä»¶ä¸Šä¸‹æ–‡
4. ğŸ’¡ **é˜…è¯»å»ºè®®** - Hook å‘Šè¯‰ä½ "ä½•æ—¶"ï¼Œä½ å†³å®š"æ˜¯å¦"
5. ğŸ’¾ **å‹ç¼©å‰ä¿å­˜** - é‡è¦ä¸Šä¸‹æ–‡å†™å…¥æ–‡ä»¶æˆ–å†…å­˜
6. ğŸ“ **ä½¿ç”¨æ‘˜è¦** - `/compact Focus on next phase` æä¾›æ–¹å‘

### æŠ€æœ¯äº®ç‚¹

**è®¾è®¡ç‰¹ç‚¹**:
- ğŸ”’ åŸå­æ–‡ä»¶æ“ä½œï¼ˆå‡å°‘ç«äº‰æ¡ä»¶ï¼‰
- ğŸ›¡ï¸ å¥å£®çš„é”™è¯¯å¤„ç†ï¼ˆæŸåæ–‡ä»¶æ¢å¤ï¼‰
- ğŸ”¢ ä¸¥æ ¼çš„è¾“å…¥éªŒè¯ï¼ˆé˜ˆå€¼èŒƒå›´æ£€æŸ¥ï¼‰
- ğŸš« éé˜»å¡è®¾è®¡ï¼ˆå§‹ç»ˆè¿”å› 0ï¼‰
- ğŸ¯ ä¼šè¯éš”ç¦»ï¼ˆç‹¬ç«‹è®¡æ•°å™¨ï¼‰

**æµ‹è¯•è¦†ç›–**:
- âœ… 19 ä¸ªæµ‹è¯•ç”¨ä¾‹
- âœ… è¾¹ç•Œæ¡ä»¶æµ‹è¯•
- âœ… é”™è¯¯åœºæ™¯æµ‹è¯•
- âœ… è·¨å¹³å°éªŒè¯

---

## å‚è€ƒèµ„æº

**GitHub Repository**:
- https://github.com/affaan-m/everything-claude-code

**ç›¸å…³æ–‡æ¡£**:
- `the-longform-guide.md` - æˆ˜ç•¥æ€§å‹ç¼©æ¦‚å¿µ
- `docs/token-optimization.md` - Token ä¼˜åŒ–æŒ‡å—
- `hooks/README.md` - Hook ç³»ç»Ÿæ¦‚è¿°

**ç›¸å…³ Skills**:
- `continuous-learning` - æŒç»­å­¦ä¹ ç³»ç»Ÿ
- `memory-persistence hooks` - å†…å­˜æŒä¹…åŒ–

**ç¤¾åŒºè®¨è®º**:
- [Anthropic: Demystifying evals for AI agents](https://www.anthropic.com/engineering/demystifying-evals-for-ai-agents)
- [Token Optimization Best Practices](https://docs.anthropic.com/en/docs/about-claude/context-window)

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-02-17 21:05:56
**åˆ†æä½œè€…**: Claude Sonnet 4.5 (AI Assistant)
**åŸºäºç‰ˆæœ¬**: everything-claude-code (latest commit)
